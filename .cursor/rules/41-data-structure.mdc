---
description: Database schema definitions, naming conventions, and data handling rules for the dna_kpi project.
globs: "lib/supabase/**/*", "lib/api/**/*", "types/*.ts", "app/**/*.{ts,tsx}", "components/**/*.{ts,tsx}"
---

# Data Structure & Schema Rules

This file serves as the **Single Source of Truth** for the project's database schema and data modeling principles.

## 1. Naming Conventions (Strict)

All database columns and related variables must follow these prefixes to ensure clarity and auto-completion grouping:

- **Values (Currency/Integer):** `val_` (e.g., `val_revenue`, `val_target`, `val_actual`)
- **Counts:** `cnt_` (e.g., `cnt_clicks`, `cnt_impressions`)
- **Ratios:** `_rate` suffix (e.g., `achievement_rate`)
- **Percentages:** `_pct` suffix (e.g., `margin_pct`)
- **Dates:** `date_` prefix (e.g., `date_target`, `date_created`)
- **Booleans:** `is_` or `has_` (e.g., `is_active`, `has_permission`)
- **Status:** `status_` (e.g., `status_payment`)

## 2. Schema Strategy

- **Project Schema:** Use `dna_kpi` schema for project-specific data.

## 3. Core Tables Definition (`dna_kpi` schema)

### 3.1 `monthly_kpi` (Merged Target & Actual)
Stores both monthly targets and accumulated actuals in a single row per category/country/month.

```sql
create table dna_kpi.monthly_kpi (
  id bigint generated always as identity primary key,

  -- Dimensions (Unique Constraint Combination)
  data_month date not null,       -- First day of the month (e.g., '2024-03-01')
  category text not null,         -- 'ads' or 'media' (enum-like check)
  country text not null,          -- 'kr' or 'us' (enum-like check)

  -- Actual Columns (Updated continuously via Upsert)
  val_actual numeric default 0,

  -- Metadata
  updated_at timestamptz default now(),

  -- Constraints
  constraint monthly_kpi_uniq unique (data_month, category, country),
  check (category in ('ads', 'media')),
  check (country in ('kr', 'us'))
);
```

### 3.2 Reference Views (from `shared`)

Do not duplicate shared tables. Use views to mirror them into the `dna_kpi` schema for consistent access.

- `dna_kpi.ref_manager` → mirrors `shared.manager`
- `dna_kpi.ref_week` → mirrors `shared.week`
- `dna_kpi.ref_holiday` → mirrors `shared.holiday`

**Usage:** These reference views are read-only. Apply any data changes in the original `shared` schema; the views reflect the source tables.
